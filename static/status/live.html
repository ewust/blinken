<html>
  <head>
    <script src='https://code.jquery.com/jquery-latest.js'></script>
    <script src='https://blinken.org/client.js'></script>
    <style>#title, #time, button { display: none; }</style>
    <script>
var latest = Array(100);
for (var i=0; i<latest.length; i++) {
    latest[i] = {a:0, r:0, g:0, b:0};
}

function run_lights(lights) {
    return function () {
        // update lights with latest data
        var i;
        for (i=0; i<lights.length; i++) {
            var bulb = latest[i];
            lights[i].rgb(bulb.r, bulb.g, bulb.b);
            lights[i].a = bulb.a;
        }
        return 10;
    };
}

function updateTitle()
{
    $.get('https://blinken.org/api/0/current', function(data) {
        var title = data.title;
        if (typeof title === 'undefined') {
            title = data.name;
        }
        $('#title')[0].innerHTML = '<a href="'+data.url+'">'+title+'</a>';

        var secs = Math.round(data.time_left);
        if (secs < 0)
            secs = 0;
        var mins = Math.floor(secs/60);
        secs = secs % 60;
        $('#time')[0].innerHTML = ''+mins+':'+((secs < 10) ? '0'+secs : secs);
    }, 'json');
}

window.onload = function() {

    var ws = new WebSocket('wss://blinken.org/api/0/stream');
    ws.binaryType = 'arraybuffer';
    ws.onmessage = function(evt) {
        var data = new Uint8Array(evt.data);
        for (var i=0; i<100; i++) {
            latest[99-i].a = data[i*4];
            latest[99-i].r = data[i*4+1];
            latest[99-i].g = data[i*4+2];
            latest[99-i].b = data[i*4+3];
        }
    }
    //setInterval(updateTitle, 500);

    var b = new Blinken();
    b.run(run_lights);
}
    </script>
  </head>
  <body>
    <div id=title></div>
    <div id=time></div>
  </body>
</html>
