<html>
  <head>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="http://blinken.eecs.umich.edu/client.js"></script>
    <script type="text/javascript">
var latest = Array(100);

for (var i=0; i<latest.length; i++) {
    latest[i] = {a:0, r:0, g:0, b:0};
}


function run_lights(lights) {
    console.log('setting up lights' + lights);
    console.log('light 0: ' + lights[0].rgb);

    return function () {
        // update lights with latest data
        var i;
        for (i=0; i<lights.length; i++) {
            var bulb = latest[i];
            lights[i].rgb(bulb.r, bulb.g, bulb.b);
            lights[i].a = bulb.a;
        }
        return 5;
    };
}

function updateTitle()
{
    $.get('http://blinken.eecs.umich.edu/current', function(data) {
        var title = data.title;
        if (typeof title === 'undefined') {
            title = data.name;
        }
        $("#title")[0].innerHTML = "<a href=\""+data.url+"\">"+title+"</a>";

        var secs = Math.round(data.time_left);
        if (secs < 0)
            secs = 0;
        var mins = Math.floor(secs/60);
        secs = secs % 60;
        $("#time")[0].innerHTML = ""+mins+":"+((secs < 10) ? '0'+secs : secs);



    }, 'json');
}

window.onload = function() {

    var ws = new WebSocket('ws://blinken.eecs.umich.edu/ws/stream');
    ws.binaryType = 'arraybuffer';
    ws.onmessage = function(evt) {
        // Update latest
        var data = new Uint8Array(evt.data);
        for (var i=0; i<100; i++) {
            latest[99-i].a = data[i*4];
            latest[99-i].r = data[i*4+1];
            latest[99-i].g = data[i*4+2];
            latest[99-i].b = data[i*4+3];
        }
    }

    setInterval(updateTitle, 500);

    var b = new Blinken();
    b.run(run_lights);

    document.getElementsByTagName('button')[0].style.display = "none";
}

    </script>
    </head>
<body>
<div id="title"></div>
<div id="time"></div>
</body>
</html>
